version: '2.1'
services:
  webserver:
    image: nginx:alpine
    container_name: webserver
    restart: unless-stopped
    tty: true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d/:/etc/nginx/conf.d/
      - ./app/build/:/app/build/
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    links:
      - api:api
    depends_on:
      - app_build
  db:
    image: postgres:9.4.5
    env_file:
      - ./api/.env.prod
    volumes:
      - /var/lib/postgresql/9.5/main:/var/lib/postgresql/data
    healthcheck:
        test: ["CMD-SHELL", "psql -h localhost -p 5432 -U postgres -v ON_ERROR_STOP=1 -c 'select version()' &> /dev/null"]
        test: ["CMD-SHELL", "pg_isready -U postgres"] #Are you really up?
        interval: 2s
        timeout: 30s
        retries: 15
  api:
    build:
      context: ./api
    links:
      - db:db
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./api/.env.prod
    tty: true
    stdin_open: true
  app_build:
    volumes:
      - ./app/build:/var/www/pomodoro/build
    build:
      context: ./app
      dockerfile: Dockerfile_production_build
    tty: true
    stdin_open: true
